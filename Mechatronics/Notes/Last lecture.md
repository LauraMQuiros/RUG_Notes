An optimal space controller $u=-Kx$, which is ideal requires measuring every state, but e want to use as few sensors as possible. So we will estimate this states. We will use the [[Separation Principle]] to separate a controller that estimates states and an observer that is fe these estimated states. This is only applicable to linear systems.

An observer receives a estimated state $\hat{x}$ from a linear system \ref and it looks like $$\begin{align} \dot{\hat{x}} &= A\hat{x} + Bu + L(y- \hat{y}) \\ \hat{y} &= C\hat{x}  + Du \end{align}$$ were $L$ is a constant matrix to determine. 
The error between true state $x$ and estimated state $\hat{x}$ is $e=x - \hat{x}$ we want $\lim_{t \to \infty}= \hat{x}$ so it follows when replacing the equations for estimated $\dot{\hat{x}}, \hat{y}$ that $\dot{e}= \dot{x} - \dot{\hat{x}}= (A-LC)e$ which implies that the eigenvalues of $A-LC$ have negative real parts

## Observer for DC motor
![[Obs-est-x.png]]

Note that the output is $y= Cx= \theta$ and if we design a PID controller $$V_s = K_p (r(t)-y(t)) + K_d (\dot{r}(t)-\dot{y}(t)) + K_i \int_0^t r(\tau) - y(\tau) d\tau$$ it asks us to get $\dot{y}= \dot{\theta}= \omega$ which is always nullified in the calculation of $y$ (not part of measured output). So let's use an observer \ref and for simplicity do $R=L=J=\mu_f=\alpha=1$ then we get an observer $$\begin{bmatrix} \dot{\hat{I}} \\ \dot{\hat{\omega}} \\ \dot{\hat{\theta}} \\ \end{bmatrix} = \begin{bmatrix} -1 & -1 & 0 \\ 1 & -1 & 0 \\ 0 & 1 & 0 \end{bmatrix}\begin{bmatrix} \hat{I} \\ \hat{\omega} \\ \hat{\theta} \end{bmatrix} + \begin{bmatrix} 1 \\ 0 \\ 0 \end{bmatrix} V_s + \begin{bmatrix} l_1 \\ l_2 \\ l_3 \end{bmatrix}\begin{bmatrix} 0 & 0 & 1\end{bmatrix}\begin{bmatrix} I- \hat{I} \\ \omega - \hat{\omega} \\ \theta - \hat{\theta}\end{bmatrix}$$ where $L$ needs to be designed so that the eigenvalues are in the left hand plane, the farthest the faster convergence $$\begin{align}A-LC &= \begin{bmatrix} -1 & -1 & -l_1 \\ 1 & -1 & -l_2 \\ 0 & 1 & -l_3\end{bmatrix} \\ 0 &= \lambda^3 + (2+l_3)\lambda^2 + (2+2l_3+l_2)\lambda + 2l_3 + l_2 + l_2  \end{align}$$ given target eigenvalues $\lambda_{1,2,3}=-100$ which leads us to $l_1= 970002, l_2=29402, l_3=298$  
## Combine Observer + LQR
system \ref without D, controller \ref ideal controller 
\ref estimated state \ref error 
closed loop system \dot{x}= Ax + Bu = (A-BK)x + BL e
leading to upper block triangular matrix, this means we can apply the \ref separation principle  $\begin{bmatrix} \dot{\tilde{x}} \\ \dot{e} \end{bmatrix} = \begin{bmatrix} A-BL & BK \\ 0 & A-LC \end{bmatrix} \begin{bmatrix} x \\ e \end{bmatrix}$

![[LQR-est-x.png]]
From this we get that $x= \begin{bmatrix} I(\tau) \\ V_c(\tau)\end{bmatrix}$ and $y=I$ so we don't get $V_c$ from the output
Now let's remember LQR's \ref cost function and \P and we solve $$\begin{align} Q &= \begin{bmatrix} 100 & 0 \\ 0 & 1 \end{bmatrix} \\ J &= \int_0^\infty \begin{bmatrix} I(\tau) & V_c(\tau) \end{bmatrix} \begin{bmatrix} 100 & 0 \\ 0 & 1 \end{bmatrix} \begin{bmatrix} I(\tau) \\ V_c(\tau) \end{bmatrix} + 100V_s(\tau) d\tau \\ P &\approx \begin{bmatrix} 83.547 & 0.9975 \\ 0.9975 & 84.961 \end{bmatrix} \\ V_s &= -R^{-1}B^TP \begin{bmatrix} 1 \\ V_c(\tau) \end{bmatrix} = - \frac{1}{100} \begin{bmatrix} 1/2 & 0 \end{bmatrix}\begin{bmatrix} 83.547 & 0.9975 \\ 0.9975 & 84.961 \end{bmatrix} \\ &= -\frac{1}{200}\begin{bmatrix} 83.547 & 0.9975 \end{bmatrix}\begin{bmatrix} 1 \\ V_c(\tau) \end{bmatrix} \\ &= -\frac{83.547}{200} - \frac{0.9975}{200}V_c\end{align}$$
but we still don't have $V_c$ and then we use the observer \ref observer $$\begin{align} \begin{bmatrix} \dot{\hat{I}} \\ \dot{\hat{V_c}} \end{bmatrix} &= \begin{bmatrix} -1/2 & -1/2 \\ 1/2 & 0 \end{bmatrix}\begin{bmatrix} \hat{I} \\ {\hat{V_c}} \end{bmatrix} + \begin{bmatrix} 1/2 \\ 0 \end{bmatrix} V_s + \begin{bmatrix} l_1 \\ l_2 \end{bmatrix}\begin{bmatrix} 1 & 0 \end{bmatrix}\begin{bmatrix} I- \hat{I} \\ V_c - \hat{V_c}\end{bmatrix} \\ 0 &= \lambda^2 + (\frac{1}{2}+l_1)\lambda + (\frac{1}{4} + \frac{l_2}{2}) \end{align}$$ and we want $\lambda_{1,2}= -100$ which leads to $l_1=199.5, l_2=-19999.5$ and then we get for the $V_s$ controller, the observed states of the observer with the L calculated